{% extends 'base.html' %}

{% block head %}
{{ super() }}
<!-- OpenLayers CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='ol/ol.css') }}">
<!-- OpenLayers JavaScript -->
<script src="{{ url_for('static', filename='ol/ol.js') }}"></script>
<script src="{{ url_for('static', filename='map-styles.js') }}"></script>
<script src="{{ url_for('static', filename='city-outline.js') }}"></script>
<style>
#map {
    height: 100vh;
    width: 100%;
    position: relative;
}

.city-info-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    max-width: 300px;
    min-width: 250px;
}

.city-info-panel h3 {
    margin-top: 0;
    color: #333;
    font-size: 18px;
}

.city-info-panel p {
    margin: 8px 0;
    color: #666;
    font-size: 14px;
}

.city-button {
    background-color: #4CAF50;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    width: 100%;
    margin-top: 10px;
    transition: all 0.3s ease;
}

.city-button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.city-button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.legend {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    z-index: 1000;
}

.legend h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #333;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.legend-color {
    width: 20px;
    height: 15px;
    margin-right: 10px;
    border: 1px solid #ccc;
}

.title-panel {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    padding: 15px 30px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    text-align: center;
}

.title-panel h1 {
    margin: 0;
    color: #333;
    font-size: 24px;
}

.title-panel p {
    margin: 5px 0 0 0;
    color: #666;
    font-size: 14px;
}
</style>
{% endblock %}

{% block content %}
<div id="map"></div>

<div class="title-panel">
    <h1>中国城市地震风险评估系统</h1>
    <p>点击地图上的城市区域查看详细信息</p>
</div>

<div class="city-info-panel" id="cityInfoPanel" style="display: none;">
    <h3 id="cityName">选择城市</h3>
    <p><strong>省份:</strong> <span id="provinceName">-</span></p>
    <p><strong>城市:</strong> <span id="cityNameDisplay">-</span></p>
    <p><strong>可用区县:</strong> <span id="districtCount">-</span> 个</p>    
    <button class="city-button" id="ruptureSelectionBtn" onclick="enterRuptureSelection()" style="background-color: #ff9800;">
        震源选择与分析
    </button>
    <button class="city-button" id="annualizedRiskBtn" onclick="enterAnnualizedRisk()" style="background-color: #9c27b0;">
        城市地震损失年均超越次数统计
    </button>
</div>

<div class="legend">
    <h4>图例</h4>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #2196F3;"></div>
        <span>可选择城市</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #81C784;"></div>
        <span>鼠标悬停</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #2E7D32;"></div>
        <span>已选择城市</span>
    </div>
</div>

<script>
// 全局变量
let map;
let cityOutline;
let selectedCity = null;
let selectedProvince = null;

// 初始化地图
function initMap() {
    // 创建地图，以中国为中心 (投影坐标系转换)
    const center = ol.proj.fromLonLat([105.0, 35.0]);
    
    map = new ol.Map({
        target: 'map',
        layers: [
            // 使用统一的地图样式配置
            MapStyles.createOpenLayersLayer()
        ],
        view: new ol.View({
            center: center,
            zoom: 5,
            minZoom: 3,
            maxZoom: 18
        })
    });
    
    // 添加底图切换控件
    const styleControl = MapStyles.createOpenLayersStyleControl(map);
    map.addControl(styleControl);
    
    // 初始化城市轮廓模块
    cityOutline = new CityOutline(map, {
        clickable: true,
        hoverable: true,
        onCityClick: (cityName, provinceName) => {
            selectCity(cityName, provinceName);
        },
        onCityHover: (cityName, provinceName) => {
            // 可以在这里添加悬停时的额外处理
        }
    });
    
    // 加载城市数据
    cityOutline.loadCityData().catch(error => {
        console.error('Error loading city data:', error);
        alert('无法加载城市数据，请刷新页面重试');
    });
}

// 选择城市
function selectCity(cityName, provinceName) {
    // 使用城市轮廓模块选择城市
    const cityInfo = cityOutline.selectCity(cityName, provinceName);
    
    selectedCity = cityName;
    selectedProvince = provinceName || cityInfo.provinceName;
    
    // 更新信息面板
    updateCityInfo(cityName, selectedProvince, cityInfo.districtCount);
    
    // 显示信息面板
    document.getElementById('cityInfoPanel').style.display = 'block';
}

// 更新城市信息面板
function updateCityInfo(city, province, districtCount) {
    document.getElementById('cityName').textContent = city;
    document.getElementById('provinceName').textContent = province;
    document.getElementById('cityNameDisplay').textContent = city;
    document.getElementById('districtCount').textContent = districtCount;
}

// 清除城市选择
function clearCitySelection() {
    // 使用城市轮廓模块清除选择
    cityOutline.clearSelection();
    
    // 清除选择状态
    selectedCity = null;
    selectedProvince = null;
    
    // 隐藏信息面板
    document.getElementById('cityInfoPanel').style.display = 'none';
}

// 进入震源选择界面
function enterRuptureSelection() {
    if (selectedCity && selectedProvince) {
        // 跳转到新的震源选择界面
        window.location.href = `/rupture_selection?province=${encodeURIComponent(selectedProvince)}&city=${encodeURIComponent(selectedCity)}`;
    }
}

// 进入年化损失分析界面
function enterAnnualizedRisk() {
    if (selectedCity && selectedProvince) {
        // 跳转到年化损失分析界面
        window.location.href = `/annualized_risk/${encodeURIComponent(selectedCity)}`;
    }
}

// 页面加载完成后初始化地图
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});
</script>
{% endblock %}
